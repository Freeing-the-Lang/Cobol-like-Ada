name: "Cobol-like-Ada â€” Build + ProofLedger + Auto Release"

on:
  push:
    paths:
      - "src/**"
      - "example.coba"
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: cobol-like-ada-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: "Build â€” ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # -------------------------------------
      # Checkout
      # -------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------
      # Install GNAT (Ubuntu only)
      # -------------------------------------
      - name: Install GNAT (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt update
          sudo apt install -y gnat

      - name: Skip GNAT install on non-Ubuntu
        if: matrix.os != 'ubuntu-latest'
        run: echo "GNAT unavailable on ${{ matrix.os }} (skipping)"

      # -------------------------------------
      # Build Ada project
      # -------------------------------------
      - name: Build (Ubuntu only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "Compiling Cobol-like-Ada..."
          gnat make src/main.adb -D src -o cobol_ada

      - name: Skip build (non-Ubuntu)
        if: matrix.os != 'ubuntu-latest'
        run: echo "Skipping build on ${{ matrix.os }}"

      # -------------------------------------
      # Run example
      # -------------------------------------
      - name: Run example (Ubuntu only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "Running example.coba..."
          ./cobol_ada > out-run.txt

      - name: Skip run (non-Ubuntu)
        if: matrix.os != 'ubuntu-latest'
        run: echo "[Skipped] Non-Ubuntu runner" > out-run.txt

      # -------------------------------------
      # ProofLedger
      # -------------------------------------
      - name: Generate ProofLedger
        run: |
          echo "Repository: Cobol-like-Ada" >  proofledger-${{ matrix.os }}-${{ github.sha }}.txt
          echo "Commit: ${{ github.sha }}" >> proofledger-${{ matrix.os }}-${{ github.sha }}.txt
          echo "OS: ${{ matrix.os }}" >> proofledger-${{ matrix.os }}-${{ github.sha }}.txt
          echo "Build time: $(date)" >> proofledger-${{ matrix.os }}-${{ github.sha }}.txt
          echo "Runner: ${{ matrix.os }}" >> proofledger-${{ matrix.os }}-${{ github.sha }}.txt
          echo "Output file: out-run.txt" >> proofledger-${{ matrix.os }}-${{ github.sha }}.txt

      # -------------------------------------
      # Artifacts
      # -------------------------------------
      - name: Upload run result
        uses: actions/upload-artifact@v4
        with:
          name: out-run-${{ matrix.os }}
          path: out-run.txt

      - name: Upload ProofLedger
        uses: actions/upload-artifact@v4
        with:
          name: proofledger-${{ matrix.os }}
          path: proofledger-${{ matrix.os }}-${{ github.sha }}.txt

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: cobol-like-ada-${{ matrix.os }}
          path: |
            cobol_ada
            cobol_ada.exe
        continue-on-error: true

  # ---------------------------------------------------
  # Release job â€” only if src/ changed
  # ---------------------------------------------------
  release:
    name: "Publish Release"
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_assets/

      - name: Create Release Tag
        id: tag
        run: echo "TAG=v_${{ github.run_number }}" >> $GITHUB_ENV

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          name: "Cobol-like-Ada Release ${{ env.TAG }}"
          body: |
            ğŸš€ **Cobol-like-Ada ìë™ ë¦´ë¦¬ì¦ˆ â€” ${{ env.TAG }}**
            - Ubuntuì—ì„œ GNATë¡œ ë¹Œë“œ ì„±ê³µ
            - example.coba ì‹¤í–‰ í¬í•¨
            - ProofLedger í¬í•¨
            - macOS/WindowsëŠ” GNAT ë¯¸ì§€ì› â†’ BUILD SKIPPED
          files: release_assets/**/*
